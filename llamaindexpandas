from llama_index.core import SimpleDirectoryReader, VectorStoreIndex
from llama_index.indices.struct_store import PandasIndex
from llama_index.agent import OpenAIAgent
from llama_index.core.tools import ToolMetadata

import pandas as pd

# 1. Load and index structured data
df = pd.read_csv("sales_data.csv")  # columns: product_name, revenue, units_sold, region
pandas_index = PandasIndex(df)
pandas_tool = pandas_index.as_query_engine()

# 2. Load and index unstructured customer feedback reports
docs = SimpleDirectoryReader("feedback_docs/").load_data()
vector_index = VectorStoreIndex.from_documents(docs)
vector_tool = vector_index.as_query_engine()

# 3. Create tools metadata
tools = [
    ToolMetadata(name="SalesDataAnalyzer", tool=pandas_tool, description="Query structured sales data"),
    ToolMetadata(name="CustomerFeedbackSearcher", tool=vector_tool, description="Search and summarize feedback documents")
]

# 4. Initialize agent with tools
agent = OpenAIAgent.from_tools(tools, verbose=True)

# 5. Run a complex query
query = """
Identify the top 3 products by total revenue from the sales data.
Then, for each product, summarize common themes from customer feedback reports.
Present the results as a ranked list with insights.
"""

response = agent.chat(query)
print(response)
